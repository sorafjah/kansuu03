<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関数グラフシミュレーター</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js for graphing -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Plotly Japanese Locale -->
    <script src="https://cdn.plot.ly/plotly-locale-ja-latest.js"></script>
    <!-- Math.js for evaluating expressions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.1/math.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        /* 数式フォント用 */
        .math-font { font-family: 'Times New Roman', Times, serif; font-style: italic; }
        
        /* カーソルのカスタマイズ: 十字矢印を「手」に変更 */
        .js-plotly-plot .plotly .cursor-ns-resize,
        .js-plotly-plot .plotly .cursor-ew-resize, 
        .js-plotly-plot .plotly .cursor-move {
            cursor: grab !important;
        }
        .js-plotly-plot .plotly .cursor-move:active {
            cursor: grabbing !important;
        }
    </style>
</head>
<!-- 背景色を bg-gray-50 から bg-white に変更 -->
<body class="bg-white text-gray-800 min-h-screen flex flex-col">

    <!-- Main Content -->
    <main class="flex-grow container mx-auto max-w-5xl p-4 md:p-6 flex flex-col md:flex-row gap-6 mt-4">
        
        <!-- Controls Sidebar -->
        <div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit flex flex-col gap-6">
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">設定パネル</h2>

            <!-- Function Input with f(x)= prefix -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">関数入力</label>
                <div class="flex items-center gap-2">
                    <span class="text-xl font-serif text-gray-600 whitespace-nowrap math-font">f(x) =</span>
                    <div class="relative w-full">
                        <input type="text" id="functionInput" value="x^2" 
                            class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono text-lg"
                            placeholder="x^2 + 2*x">
                    </div>
                </div>
                <p id="errorMsg" class="text-red-500 text-xs mt-1 hidden text-right">式に誤りがあります</p>
            </div>

            <!-- Range Inputs -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">表示範囲設定</label>
                
                <!-- X Axis -->
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">X 最小値</label>
                        <input type="number" id="xMin" value="-5" 
                            class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">X 最大値</label>
                        <input type="number" id="xMax" value="5" 
                            class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <!-- Y Axis -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Y 最小値</label>
                        <input type="number" id="yMin" value="-10" 
                            class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Y 最大値</label>
                        <input type="number" id="yMax" value="10" 
                            class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <!-- Pre-set Buttons -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">プリセット</label>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="setFunc('x^2', -10, 10, -5, 15)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">x<sup>2</sup></button>
                    <button onclick="setFunc('2^x', -5, 5, 0, 10)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">2<sup>x</sup></button>
                    <button onclick="setFunc('sin(x)', -6, 6, -2, 2)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">sin(x)</button>
                    <button onclick="setFunc('tan(x)', -5, 5, -5, 5)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">tan(x)</button>
                    <!-- ルートの見た目をCSSで調整 -->
                    <button onclick="setFunc('sqrt(x)', 0, 10, 0, 5)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition flex items-center">
                        <span style="font-family: serif;">√</span><span style="border-top: 1px solid currentColor; line-height: 1; padding-top: 1px;">x</span>
                    </button>
                    <button onclick="setFunc('log(x)', 0, 10, -5, 5)" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">log(x)</button>
                </div>

                <!-- Recalculate Button -->
                <button onclick="recalculateFromView()" 
                    class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    今の範囲で再計算
                </button>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                <h3 class="font-bold mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    入力のヒント
                </h3>
                <ul class="list-disc list-inside space-y-1 ml-1 text-xs">
                    <li>べき乗: <code class="bg-blue-100 px-1 rounded">x^2</code> または <code class="bg-blue-100 px-1 rounded">x**2</code></li>
                    <li>掛け算: <code class="bg-blue-100 px-1 rounded">2*x</code> (×は省略不可)</li>
                    <li>三角関数: <code class="bg-blue-100 px-1 rounded">sin(x)</code>, <code class="bg-blue-100 px-1 rounded">tan(x)</code></li>
                </ul>
            </div>
        </div>

        <!-- Graph Area -->
        <div class="w-full md:w-2/3 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative group">
            <div id="plot" class="w-full h-full min-h-[400px]"></div>
            
            <!-- Loading Overlay -->
            <div id="loading" class="absolute inset-0 bg-white/80 hidden items-center justify-center pointer-events-none">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 text-gray-500 text-center py-4 text-xs mt-auto">
        &copy; 2024 Graph Simulator. Created with Plotly.js & Math.js
    </footer>

    <script>
        // --- 設定 ---
        const config = {
            responsive: true,
            displayModeBar: true, 
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d', 'pan2d'],
            scrollZoom: false, // 自動ズーム（スクロール）を削除
            locale: 'ja' 
        };

        // dragmodeの初期値は'pan'
        const layout = {
            margin: { t: 40, r: 40, b: 40, l: 60 },
            autosize: true,
            dragmode: 'pan',
            xaxis: {
                title: 'x',
                zeroline: true,
                zerolinecolor: '#333',
                zerolinewidth: 2,
                gridcolor: '#eee'
            },
            yaxis: {
                title: 'y',
                zeroline: true,
                zerolinecolor: '#333',
                zerolinewidth: 2,
                gridcolor: '#eee',
                autorange: false 
            },
            hovermode: 'closest',
            paper_bgcolor: '#fff',
            plot_bgcolor: '#fff'
        };

        // --- 文字列サニタイズ（全角→半角変換） ---
        function sanitizeInput(str) {
            if (!str) return "";
            let s = str.replace(/[！-～]/g, function(ch) {
                return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
            });
            s = s.replace(/　/g, " ")
                 .replace(/×/g, "*")
                 .replace(/÷/g, "/")
                 .replace(/−/g, "-")
                 .replace(/ー/g, "-");
            return s;
        }

        // --- メイン処理 ---
        function drawGraph() {
            let expressionStr = document.getElementById('functionInput').value;
            const xMin = parseFloat(document.getElementById('xMin').value);
            const xMax = parseFloat(document.getElementById('xMax').value);
            const yMin = parseFloat(document.getElementById('yMin').value);
            const yMax = parseFloat(document.getElementById('yMax').value);
            const errorMsg = document.getElementById('errorMsg');

            expressionStr = sanitizeInput(expressionStr);

            if (isNaN(xMin) || isNaN(xMax) || xMin >= xMax) return;
            const useYRange = !isNaN(yMin) && !isNaN(yMax) && yMin < yMax;

            try {
                errorMsg.classList.add('hidden');
                document.getElementById('functionInput').classList.remove('border-red-500');

                const expr = math.compile(expressionStr);
                const xValues = [];
                const yValues = [];
                
                const range = xMax - xMin;
                const points = Math.min(2500, Math.max(800, range * 100)); 
                const step = range / points;
                
                const yRange = useYRange ? (yMax - yMin) : 20;
                const discontinuityThreshold = yRange * 5; 

                let prevY = null;

                for (let x = xMin; x <= xMax; x += step) {
                    try {
                        let y = expr.evaluate({ x: x });
                        
                        if (typeof y === 'object' && 're' in y) y = NaN; 
                        if (!isFinite(y)) y = NaN;
                        if (Math.abs(y) > 1e9) y = NaN;

                        if (prevY !== null && !isNaN(prevY) && !isNaN(y)) {
                            const diff = Math.abs(y - prevY);
                            if (diff > discontinuityThreshold) {
                                xValues.push(x);
                                yValues.push(null); 
                                prevY = y;
                                xValues.push(x);
                                yValues.push(y);
                                continue;
                            }
                        }

                        xValues.push(x);
                        yValues.push(y);
                        prevY = y;

                    } catch (e) {
                        xValues.push(x);
                        yValues.push(NaN);
                        prevY = NaN;
                    }
                }

                const trace = {
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    type: 'scatter',
                    name: `f(x)`,
                    line: { color: '#2563eb', width: 2.5 }
                };

                layout.xaxis.range = [xMin, xMax];
                
                if (useYRange) {
                    layout.yaxis.range = [yMin, yMax];
                    layout.yaxis.autorange = false;
                } else {
                    layout.yaxis.autorange = true;
                }
                
                // 設定オブジェクトを維持しつつ描画
                Plotly.react('plot', [trace], layout, config);
                
                // イベントリスナーのセットアップ（モードバーボタン監視用）
                setupModeBarListeners();

            } catch (err) {
                errorMsg.textContent = "式の形式が正しくありません";
                errorMsg.classList.remove('hidden');
                document.getElementById('functionInput').classList.add('border-red-500');
            }
        }

        // --- 表示範囲に合わせて再計算 ---
        function recalculateFromView() {
            const plotDiv = document.getElementById('plot');
            if (plotDiv.layout) {
                if (plotDiv.layout.xaxis && plotDiv.layout.xaxis.range) {
                    const xRange = plotDiv.layout.xaxis.range;
                    document.getElementById('xMin').value = parseFloat(xRange[0]).toFixed(2);
                    document.getElementById('xMax').value = parseFloat(xRange[1]).toFixed(2);
                }
                if (plotDiv.layout.yaxis && plotDiv.layout.yaxis.range) {
                    const yRange = plotDiv.layout.yaxis.range;
                    document.getElementById('yMin').value = parseFloat(yRange[0]).toFixed(2);
                    document.getElementById('yMax').value = parseFloat(yRange[1]).toFixed(2);
                }
                
                drawGraph();
            }
        }

        // --- モードバーの挙動制御 ---
        function setupModeBarListeners() {
            const plotDiv = document.getElementById('plot');
            
            // リセットイベント等の監視 (plotly_relayout は標準で発火する)
            if (!plotDiv._customListenersAttached) {
                plotDiv.on('plotly_relayout', function(eventData) {
                    // 軸のリセット（オートスケール）が行われた場合
                    if (eventData['xaxis.autorange'] || eventData['yaxis.autorange'] || (eventData['xaxis.range[0]'] === undefined && Object.keys(eventData).length === 0)) {
                        // 少し待ってからPanモードに戻す
                        setTimeout(() => {
                            Plotly.relayout(plotDiv, {dragmode: 'pan'});
                        }, 50);
                    }
                });

                // モードバーボタンのクリック監視（トグル動作用）
                plotDiv.addEventListener('click', function(e) {
                    const btn = e.target.closest('.modebar-btn');
                    if (!btn) return;

                    const attr = btn.getAttribute('data-attr');
                    // 'zoom'ボタンが押されたとき
                    if (attr === 'zoom') {
                        // 現在のモードが既にZoomなら、Panに戻す
                        if (plotDiv.layout.dragmode === 'zoom') {
                            setTimeout(() => {
                                Plotly.relayout(plotDiv, {dragmode: 'pan'});
                            }, 10);
                        }
                    }
                    // リセットボタン系
                    if (attr === 'reset' || attr === 'zoom_reset') {
                        setTimeout(() => {
                            Plotly.relayout(plotDiv, {dragmode: 'pan'});
                        }, 10);
                    }
                });
                
                plotDiv._customListenersAttached = true;
            }
        }

        // --- イベントリスナー ---
        const inputs = ['functionInput', 'xMin', 'xMax', 'yMin', 'yMax'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', debounce(drawGraph, 500));
        });
        
        window.addEventListener('resize', () => {
            Plotly.Plots.resize('plot');
        });

        // プリセットボタン用関数
        function setFunc(func, xMin, xMax, yMin, yMax) {
            document.getElementById('functionInput').value = func;
            
            if (xMin !== undefined) document.getElementById('xMin').value = xMin;
            if (xMax !== undefined) document.getElementById('xMax').value = xMax;
            if (yMin !== undefined) document.getElementById('yMin').value = yMin;
            if (yMax !== undefined) document.getElementById('yMax').value = yMax;
            
            drawGraph();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 初期描画
        drawGraph();

    </script>
</body>
</html>
