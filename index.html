<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関数グラフシミュレーター</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js for graphing -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Math.js for evaluating expressions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.1/math.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto max-w-5xl flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                </svg>
                Graph Simulator
            </h1>
            <span class="text-sm bg-blue-700 py-1 px-3 rounded-full">Web Edition</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto max-w-5xl p-4 md:p-6 flex flex-col md:flex-row gap-6">
        
        <!-- Controls Sidebar -->
        <div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
            <h2 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">設定パネル</h2>

            <!-- Function Input -->
            <div class="mb-5">
                <label class="block text-sm font-medium text-gray-700 mb-1">関数 f(x)</label>
                <div class="relative">
                    <input type="text" id="functionInput" value="x^2" 
                        class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono text-lg"
                        placeholder="例: x^2 + 2*x">
                </div>
                <p id="helperText" class="text-gray-400 text-xs mt-1">全角入力は自動変換されます</p>
                <p id="errorMsg" class="text-red-500 text-xs mt-1 hidden">式に誤りがあります</p>
            </div>

            <!-- Range Inputs -->
            <div class="grid grid-cols-2 gap-4 mb-5">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">X 最小値</label>
                    <input type="number" id="xMin" value="-10" 
                        class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">X 最大値</label>
                    <input type="number" id="xMax" value="10" 
                        class="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
            </div>

            <!-- Pre-set Buttons -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">プリセット</label>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setFunc('x^2')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">2次関数</button>
                    <button onclick="setFunc('sin(x)')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">サイン波</button>
                    <button onclick="setFunc('1/x')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">反比例</button>
                    <button onclick="setFunc('sqrt(x)')" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700 transition">ルート</button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                <h3 class="font-bold mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    入力のヒント
                </h3>
                <ul class="list-disc list-inside space-y-1 ml-1 text-xs">
                    <li>べき乗: <code class="bg-blue-100 px-1 rounded">x^2</code> または <code class="bg-blue-100 px-1 rounded">x**2</code></li>
                    <li>掛け算: <code class="bg-blue-100 px-1 rounded">2*x</code> (×は省略不可)</li>
                    <li>三角関数: <code class="bg-blue-100 px-1 rounded">sin(x)</code>, <code class="bg-blue-100 px-1 rounded">cos(x)</code></li>
                    <li>定数: <code class="bg-blue-100 px-1 rounded">pi</code>, <code class="bg-blue-100 px-1 rounded">e</code></li>
                </ul>
            </div>
        </div>

        <!-- Graph Area -->
        <div class="w-full md:w-2/3 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative">
            <div id="plot" class="w-full h-full min-h-[400px]"></div>
            
            <!-- Loading Overlay (hidden by default) -->
            <div id="loading" class="absolute inset-0 bg-white/80 hidden items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 text-gray-500 text-center py-4 text-xs mt-auto">
        &copy; 2024 Graph Simulator. Created with Plotly.js & Math.js
    </footer>

    <script>
        // --- 設定 ---
        const config = {
            responsive: true,
            displayModeBar: true, // ズームなどのツールバーを表示
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };

        const layout = {
            margin: { t: 40, r: 40, b: 40, l: 60 },
            autosize: true,
            xaxis: {
                title: 'x',
                zeroline: true,
                zerolinecolor: '#333',
                zerolinewidth: 2,
                gridcolor: '#eee'
            },
            yaxis: {
                title: 'y',
                zeroline: true,
                zerolinecolor: '#333',
                zerolinewidth: 2,
                gridcolor: '#eee'
            },
            hovermode: 'closest',
            paper_bgcolor: '#fff',
            plot_bgcolor: '#fff'
        };

        // --- 文字列サニタイズ（全角→半角変換） ---
        function sanitizeInput(str) {
            if (!str) return "";
            
            // 1. 全角英数字・記号を半角に変換 (ASCII範囲)
            let s = str.replace(/[！-～]/g, function(ch) {
                return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
            });

            // 2. その他の記号の正規化
            s = s.replace(/　/g, " ")     // 全角スペース
                 .replace(/×/g, "*")     // 掛ける
                 .replace(/÷/g, "/")     // 割る
                 .replace(/−/g, "-")     // 全角マイナス等のバリエーション
                 .replace(/ー/g, "-");    // 長音（マイナスと間違えやすい）

            return s;
        }

        // --- メイン処理 ---
        function drawGraph() {
            let expressionStr = document.getElementById('functionInput').value;
            const xMin = parseFloat(document.getElementById('xMin').value);
            const xMax = parseFloat(document.getElementById('xMax').value);
            const errorMsg = document.getElementById('errorMsg');

            // 入力の正規化（全角対策）
            expressionStr = sanitizeInput(expressionStr);

            // バリデーション
            if (isNaN(xMin) || isNaN(xMax) || xMin >= xMax) {
                // 範囲エラーは静かに無視してデフォルトに戻さない（ユーザー体験のため）
                return;
            }

            try {
                errorMsg.classList.add('hidden');
                document.getElementById('functionInput').classList.remove('border-red-500');

                // 式をコンパイル (Math.jsを使用)
                const expr = math.compile(expressionStr);

                // データを生成
                const xValues = [];
                const yValues = [];
                const step = (xMax - xMin) / 500; // 500点で描画

                for (let x = xMin; x <= xMax; x += step) {
                    try {
                        // スコープを作成してxを代入
                        let y = expr.evaluate({ x: x });
                        
                        // 複素数や無限大のチェック
                        if (typeof y === 'object' && 're' in y) {
                             // 複素数が返ってきた場合は実部だけ使うか、NaNにする
                             y = NaN; 
                        }
                        if (!isFinite(y)) {
                            y = NaN; // 無限大は描画しない
                        }
                        
                        xValues.push(x);
                        yValues.push(y);
                    } catch (e) {
                        xValues.push(x);
                        yValues.push(NaN);
                    }
                }

                // Plotlyで描画
                const trace = {
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    type: 'scatter',
                    name: `f(x) = ${expressionStr}`,
                    line: {
                        color: '#2563eb', // blue-600
                        width: 3
                    }
                };

                // レイアウトの範囲更新
                layout.xaxis.range = [xMin, xMax];
                
                // 初回描画か更新かで分ける
                Plotly.react('plot', [trace], layout, config);

            } catch (err) {
                // コンパイルエラーが発生した場合
                // console.error(err); // デバッグ用
                errorMsg.textContent = "式の形式が正しくありません";
                errorMsg.classList.remove('hidden');
                document.getElementById('functionInput').classList.add('border-red-500');
            }
        }

        // --- イベントリスナー ---
        
        // 入力変更時にグラフを更新
        document.getElementById('functionInput').addEventListener('input', debounce(drawGraph, 500));
        document.getElementById('xMin').addEventListener('input', debounce(drawGraph, 500));
        document.getElementById('xMax').addEventListener('input', debounce(drawGraph, 500));
        
        // ウィンドウサイズ変更時にグラフサイズ調整
        window.addEventListener('resize', () => {
            Plotly.Plots.resize('plot');
        });

        // プリセットボタン用関数
        function setFunc(func) {
            document.getElementById('functionInput').value = func;
            drawGraph();
        }

        // デバウンス関数（入力のたびに処理が走りすぎないようにする）
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 初期描画
        drawGraph();

    </script>
</body>
</html>
